[build-system]
requires = ["maturin>=1.4,<2.0"]
build-backend = "maturin"

[project]
name = "openlabels"
version = "0.1.0"
description = "Universal Data Risk Scoring - Labels are the primitive, risk is derived"
readme = "README.md"
license = {text = "Apache-2.0"}
requires-python = ">=3.9"
authors = [
    {name = "OpenLabels Contributors"}
]
keywords = ["data-sensitivity", "pii", "phi", "dlp", "risk-scoring", "data-governance"]
classifiers = [
    "Development Status :: 3 - Alpha",
    "Intended Audience :: Developers",
    "Intended Audience :: Information Technology",
    "Topic :: Security",
    "Topic :: Software Development :: Libraries :: Python Modules",
    "License :: OSI Approved :: Apache Software License",
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.9",
    "Programming Language :: Python :: 3.10",
    "Programming Language :: Python :: 3.11",
    "Programming Language :: Python :: 3.12",
    "Operating System :: OS Independent",
]
# SECURITY FIX (MED-001): regex is REQUIRED for ReDoS timeout protection
# Without it, user-controlled regex patterns can hang the process indefinitely
dependencies = [
    "regex>=2023.0.0,<2025.0.0",  # REQUIRED: ReDoS timeout protection (CVE-READY-003)
    "rich>=13.0.0,<14.0.0",  # CLI output formatting and progress bars
]

[project.optional-dependencies]
# SECURITY FIX (MED-003): Bump minimum versions to include security patches
pdf = ["pymupdf>=1.23.11,<1.25.0"]  # 1.23.11 fixes CVE-2023-51105, CVE-2023-51104
office = [
    "python-docx>=1.0.0,<2.0.0",
    "openpyxl>=3.1.0,<4.0.0",
    "xlrd>=2.0.0,<3.0.0",  # SECURITY FIX (HIGH-014): Declare XLS dependency
    "striprtf>=0.0.26,<1.0.0",  # SECURITY FIX (HIGH-014): Declare RTF dependency
]
images = ["pillow>=10.3.0,<11.0.0"]  # 10.3.0 fixes CVE-2024-28219 (buffer overflow)
ocr = [
    "numpy>=1.24.0,<2.0.0",
    "onnxruntime>=1.16.0,<2.0.0",
    "rapidocr-onnxruntime>=1.3.0,<2.0.0",
    "intervaltree>=3.1.0,<4.0.0",  # SECURITY FIX (HIGH-014): Declare OCR dependency
]
performance = ["pyahocorasick>=2.0.0,<3.0.0"]
# Archive extraction support
archives = [
    "py7zr>=0.20.0,<1.0.0",  # 7z archive extraction
    "rarfile>=4.1,<5.0.0",   # RAR archive extraction (requires unrar binary)
]
# Database backends for server mode
database = [
    "psycopg[binary]>=3.1.0,<4.0.0",  # PostgreSQL support (async + connection pooling)
]
# GUI (large dependency - install only if needed)
gui = [
    "PySide6>=6.5.0,<7.0.0",  # Qt6 GUI framework (~150MB)
    "openlabels[auth]",        # Auth required for vault features
]
# Async scanner API server (for GUI backend or standalone service)
server = [
    "fastapi>=0.109.0,<1.0.0",  # REST API framework
    "uvicorn>=0.27.0,<1.0.0",   # ASGI server
    "pydantic>=2.5.0,<3.0.0",   # Data validation (required by FastAPI)
]
# Authentication and vault encryption
auth = [
    "argon2-cffi>=23.1.0,<24.0.0",      # Argon2 password hashing (OWASP recommended)
    "cryptography>=42.0.0,<44.0.0",     # AES-256-GCM vault encryption
    "PyJWT>=2.8.0,<3.0.0",              # JWT session tokens
]
# Security-hardened production deployment (includes all security-critical deps)
security = [
    "regex>=2023.0.0,<2025.0.0",  # ReDoS timeout protection (also in base deps)
    "py7zr>=0.20.0,<1.0.0",       # Secure 7z extraction with limits
    "psycopg[binary]>=3.1.0,<4.0.0",  # Parameterized queries for DB backend
]
all = [
    "openlabels[pdf,office,images,ocr,performance,archives,database,auth,gui,server]",
]
dev = [
    "pytest>=7.0.0",
    "pytest-cov>=4.0.0",
    "pytest-qt>=4.2.0",
    "pytest-xvfb>=3.0.0",
    "mypy>=1.0.0",
    "ruff>=0.1.0",
]

[project.scripts]
openlabels = "openlabels.cli.main:main"

[project.urls]
Homepage = "https://github.com/openlabels/openlabels"
Documentation = "https://openlabels.dev/docs"
Repository = "https://github.com/openlabels/openlabels"
Issues = "https://github.com/openlabels/openlabels/issues"

[tool.ruff]
line-length = 100
target-version = "py39"

[tool.ruff.lint]
select = ["E", "F", "W", "I", "UP", "B", "C4"]
ignore = ["E501"]

[tool.mypy]
python_version = "3.9"
warn_return_any = true
warn_unused_configs = true
disallow_untyped_defs = false

[tool.pytest.ini_options]
testpaths = ["tests"]
python_files = ["test_*.py"]
python_functions = ["test_*"]
# Disable pytest-qt by default (fails on headless systems without Qt libs)
# To run GUI tests: pytest -p pytest_qt tests/test_gui.py
addopts = "-p no:pytest_qt -p no:pytest_xvfb"
markers = [
    "gui: mark test as requiring Qt GUI",
]

[tool.maturin]
# Build the Rust extension as openlabels._rust
module-name = "openlabels._rust"
# Include Python source
python-source = "."
# Build features
features = ["pyo3/extension-module"]
# Compatibility for Linux
compatibility = "manylinux2014"
